# kozosを制作するにあたってのメモ

## メモリマップドI/O

### チップセレクト信号とメモリのマッピング (前提)

CPUとDRAMのアドレスバスのうち、上位数本(メモリアドレスが32bitの場合12本)は特殊な役割を持ち、各DRAMのチップセレクトピンに、各比較器を挟んで接続される。
下位の線(32bitの場合は20本)はそれぞれが複数のDRAMチップに接続されている

DRAMのうち一つのピンがCS(Chip Select)やCE(Chip Enable)という信号ピンとされる。
このピンが1のときのみチップが動作するようになっている。

アドレスバスの上位数本の値により、どのDRAMに接続するかが決まる。
上位数本の線は、自分のDRAMチップが指し示されたときのみ1を返すよう比較器(論理回路)を通して、各DRAMのチップセレクトピンにつながる。

これにより、アドレスバス全幅を使って番地を示すと、実際には複数のDRAMが協調して分散にデータを保持する。

のが前置き。。。

### メモリマップドI/O

メモリマップドI/Oは、メモリの一部に重なるようにI/Oをマッピングすること。

例えばメモリアドレス32bitのとき、DRAMに接続するのに重ねて、上位28本を比較器を通して1本のシリアルコントローラのCSに、下位4本をシリアルコントローラに接続する。

こうすると、上位28本のピンが特定の値のとき、下位4本でシリアルコントローラと接続・通信される。
このとき同時にメモリの特定の領域とも接続・通信されるので、メモリの一部に重ねてI/O(今回の場合シリアルコントローラ)がマッピングされる。

これによりメモリの読み書きをするだけで、I/Oも利用できる。

### I/OマップドI/O

メモリマップドI/Oに対比する言葉。
メモリとは別アドレスにI/Oを配置し、専用命令で操作する。

## volatile

C言語の型に対する修飾子。コンパイラによる最適化を抑制する。

最適化によりレジスタへの書き込み順序が逆になることがあり、これが起こるとハードウェアの仕様に合致しない、意図しない動作が起こることがある。これを防ぐため、volatileを使用する。

また、メモリの値はプログラム外のI/Oなどにより値が変わることがあるので、プログラム上の論理的な等価性と実際の動作の動作の等価が一致しない可能性がある。このことからもvolatileを使用することがある。

## H8/3069Fのメモリ構成

0x000000 - 0x0000ff ... 割り込みベクタ
0x000000 - 0x07ffff ... 内蔵ROM(512KB)
0xffbf20 - 0xffff1f ... 内蔵RAM(16KB)
0xffff20 - 0xffffe9 ... 内蔵I/Oレジスタ

## メモリ上の静的領域

CPUはメモリにロードされたプログラムのみを実行できる。メモリにロードするときは次の3つの領域に分かれてコピーされる。

- テキスト領域 ... CPUが実行する機械語コードが置かれる
- データ領域 ... 初期値を持つ静的変数などが置かれる
- BSS領域 ... 初期値を持たない静的変数などが置かれる

## ブートローダー

フラッシュROMの書き換え数制限から、起動時にOSをシリアル経由でダウンロードし、RAM上に展開するプログラムのこと。

ブートローダーを利用した起動方法をブートストラップと呼ぶ。

シリアル経由でのダウンロードは、XMODEMプロトコルを利用する。

